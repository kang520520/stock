<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é›„Stock Scanner Pro (ç©©å®šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; }
        .filter-card { border-left: 4px solid #4f46e5; transition: all 0.2s; }
        thead th { position: sticky; top: 0; background: #f1f5f9; z-index: 20; white-space: nowrap; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .line-clamp-2 { 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
            line-height: 1.6 !important; 
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-container { overflow-x: auto; max-height: 750px; width: 100%; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        
        .datalist-input::-webkit-calendar-picker-indicator {
            display: none !important;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">
    <div class="max-w-[1750px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-indigo-600 tracking-tight italic uppercase">å¤§é›„Stock Scanner Pro</h1>
                <p class="text-slate-500 text-sm mt-1 font-bold italic">è²¡å¯Œè‡ªç”± (åŠæ™‚é è¦½æ¸¬è©¦)</p>
            </div>
            <div class="flex flex-col items-end gap-1">
                <div class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl shadow-sm border border-slate-200">
                    <div id="spinner" class="loading-spinner"></div>
                    <span id="status" class="text-sm font-bold text-slate-600 italic">æ­£åœ¨å–šé†’è³‡æ–™åº«...</span>
                </div>
                <span id="update-date" class="text-[10px] font-black text-indigo-400 mr-2 uppercase tracking-widest italic">è³‡æ–™æ—¥æœŸï¼šè®€å–ä¸­...</span>
            </div>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-200">
            <div class="mb-6 bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 flex flex-col md:flex-row gap-4 items-center">
                <div class="relative flex-1 w-full">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 font-bold">ğŸ”</span>
                    <input type="text" id="keyword-search" oninput="runFilter()" 
                        class="block w-full pl-10 pr-3 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-bold shadow-inner" 
                        placeholder="æœå°‹ä»£è™Ÿã€å…¬å¸åç¨± (åŠæ™‚æ›´æ–°ä¸­)">
                </div>
            </div>

            <div id="filter-container" class="space-y-3"></div>

            <div class="mt-8 flex flex-wrap gap-3 border-t border-slate-100 pt-6 items-center">
                <button onclick="addFilterRow()" class="bg-slate-800 text-white px-6 py-3 rounded-xl hover:bg-slate-700 transition font-bold shadow-lg text-[14px]">+ æ–°å¢æŒ‡æ¨™ç¯©é¸</button>
                <div class="flex-1 flex items-center gap-4">
                    <button onclick="runFilter()" class="bg-indigo-600 text-white px-10 py-3 rounded-xl font-black hover:bg-indigo-700 transition shadow-lg text-[14px]">åŸ·è¡Œé¸è‚¡</button>
                    <div class="bg-indigo-50 px-4 py-2.5 rounded-xl border border-indigo-100 flex items-center">
                        <span class="text-indigo-400 text-xs font-bold uppercase tracking-widest mr-2">ç¬¦åˆæ”¯æ•¸</span>
                        <span id="result-count-badge" class="text-indigo-600 font-black text-[18px]">0</span>
                    </div>
                </div>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition text-[14px]">åŒ¯å‡ºçµæœ</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="table-container">
                <table class="text-left border-collapse">
                    <thead id="table-head">
                        <tr class="text-slate-400 text-[11px] uppercase tracking-widest border-b">
                            <th class="p-4">ç­‰å¾…é€£ç·šä¸­...</th>
                        </tr>
                    </thead>
                    <tbody id="stock-list" class="text-slate-700 divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // æ”¹ç”¨ 10.4.0 ç‰ˆæœ¬ï¼Œæ­¤ç‰ˆæœ¬åœ¨ StackBlitz ç’°å¢ƒæœ€ç©©å®š
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcrQxCW62uLQpwra3gAHBedfhixQ8xdYU",
            authDomain: "test-f194b.firebaseapp.com",
            projectId: "test-f194b",
            storageBucket: "test-f194b.firebasestorage.app",
            messagingSenderId: "538788175196",
            appId: "1:538788175196:web:f73a483780f656f85a7599"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let allStocks = [], sortKey = '', sortDirection = 1, uniqueOptions = {};

        const indicatorGroups = {
            "ğŸ¯ æ ¸å¿ƒæŒ‡æ¨™": ["åƒ¹æ ¼", "æ¼²è·Œ", "æ¼²è·Œå¹…", "æˆäº¤é‡", "ç±Œç¢¼åŠ›é“", "ç”¢æ¥­", "è‚¡æœ¬(å„„)"],
            "ğŸ’° ç±Œç¢¼å‹•å‘": ["å¤–è³‡è²·è³£è¶…", "æŠ•ä¿¡è²·è³£è¶…", "è‡ªç‡Ÿå•†è²·è³£è¶…", "è¿‘1æ—¥ä¸»åŠ›è²·è³£è¶…", "è¿‘5æ—¥ä¸»åŠ›è²·è³£è¶…", "è¿‘20æ—¥ä¸»åŠ›è²·è³£è¶…", "ä¸»åŠ›é€£çºŒè²·è³£å¤©æ•¸", "ä¸»åŠ›é€£çºŒè²·è³£å¼µæ•¸"],
            "ğŸ“Š é›†ä¸­åº¦": ["è¿‘5æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘10æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘20æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘60æ—¥ç±Œç¢¼é›†ä¸­åº¦"],
            "ğŸ’ è²¡å ±å›å ±": ["è¿‘5å¹´å¹³å‡ç¾é‡‘æ®–åˆ©ç‡%"]
        };

        async function init() {
            const status = document.getElementById('status'), dateTxt = document.getElementById('update-date'), spinner = document.getElementById('spinner');
            
            try {
                // ä¸è¨­è¶…æ™‚ï¼Œè®“å®ƒç©©ç©©é€£ç·š
                const dSnap = await getDoc(doc(db, "settings", "lastUpdate"));
                if (dSnap.exists()) dateTxt.innerText = "è³‡æ–™æ—¥æœŸï¼š" + dSnap.data().date;

                const snap = await getDocs(collection(db, "stocks"));
                allStocks = snap.docs.map(doc => doc.data());

                ["ç±Œç¢¼åŠ›é“", "ç”¢æ¥­"].forEach(k => {
                    let set = new Set();
                    allStocks.forEach(s => { const v = fuzzyGet(s, k); if(v) set.add(v); });
                    uniqueOptions[k] = Array.from(set).sort();
                });

                status.innerText = `å·²è¼‰å…¥ ${allStocks.length} æ”¯`;
                spinner.style.display = 'none';
                if(document.getElementById('filter-container').children.length === 0) addFilterRow();
                runFilter();
            } catch (e) { 
                console.error(e);
                status.innerText = "é€£ç·šå˜—è©¦ä¸­..."; 
                // å¤±æ•—æ™‚ä¸€ç§’å¾Œè‡ªå‹•éœé»˜é‡è©¦ï¼Œä¸éœ€è¦ä½¿ç”¨è€…æ‰‹å‹•é‡æ•´
                setTimeout(init, 2000);
            }
        }

        function fuzzyGet(obj, target) {
            if (!obj) return "";
            if (obj[target] !== undefined) return obj[target];
            const cleanTarget = target.toString().trim().replace(/"/g, "");
            const realKey = Object.keys(obj).find(k => k.toString().trim().replace(/"/g, "").replace(/\ufeff/g, "").includes(cleanTarget));
            return realKey ? obj[realKey] : "";
        }

        window.addFilterRow = function() {
            const container = document.getElementById('filter-container');
            const row = document.createElement('div');
            row.className = "filter-card flex flex-wrap gap-3 bg-slate-50 p-4 rounded-2xl items-center shadow-sm animate-fadeIn";
            let groups = "";
            for (let g in indicatorGroups) {
                groups += `<optgroup label="${g}">`;
                indicatorGroups[g].forEach(i => groups += `<option value="${i}">${i}</option>`);
                groups += `</optgroup>`;
            }
            row.innerHTML = `<select onchange="updateValueInput(this)" class="indicator-select p-2 border rounded-xl bg-white w-full md:w-64 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500">${groups}</select>
                <select class="operator-select p-2 border rounded-xl bg-white w-20 text-center font-black"><option value=">=">â‰¥</option><option value="<=">â‰¤</option><option value="==">=</option><option value="include">å«</option></select>
                <div class="value-container flex-1 md:flex-none"></div>
                <button onclick="this.parentElement.remove(); runFilter();" class="ml-auto text-slate-300 hover:text-red-500 font-bold px-2 text-xl">âœ•</button>`;
            container.appendChild(row);
            updateValueInput(row.querySelector('.indicator-select'));
        }

        window.updateValueInput = function(selectEl) {
            const row = selectEl.parentElement, valContainer = row.querySelector('.value-container'), key = selectEl.value;
            if (key === "åƒ¹æ ¼") {
                valContainer.innerHTML = `
                    <input list="ma-options" class="p-2 border rounded-xl bg-white w-full md:w-32 font-black text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="æ•¸å­—æˆ–MA">
                    <datalist id="ma-options">
                        <option value="5MA">
                        <option value="10MA">
                        <option value="20MA">
                        <option value="60MA">
                    </datalist>`;
            } else if (["ç±Œç¢¼åŠ›é“", "ç”¢æ¥­"].includes(key)) {
                let opts = (uniqueOptions[key] || []).map(o => `<option value="${o}">${o}</option>`).join('');
                valContainer.innerHTML = `<select class="p-2 border rounded-xl bg-white w-full md:w-48 font-bold text-indigo-600">${opts}</select>`;
                row.querySelector('.operator-select').value = "include";
            } else {
                valContainer.innerHTML = `<input type="number" step="any" class="p-2 border rounded-xl bg-white w-full md:w-32 font-black text-indigo-600">`;
                row.querySelector('.operator-select').value = ">=";
            }
        }

        window.runFilter = function() {
            const keyword = document.getElementById('keyword-search')?.value.toLowerCase().trim() || "";
            const filterRows = document.querySelectorAll('#filter-container > div');
            const filters = Array.from(filterRows).map(r => {
                const input = r.querySelector('.value-container').querySelector('input, select');
                return {
                    key: r.querySelector('.indicator-select').value, 
                    op: r.querySelector('.operator-select').value, 
                    val: input ? input.value : ""
                }
            });

            let result = allStocks.filter(s => {
                const id = String(fuzzyGet(s, "ä»£ç¢¼")).replace(/"/g, ""), name = String(fuzzyGet(s, "åç¨±")).toLowerCase();
                if (keyword && !id.includes(keyword) && !name.includes(keyword)) return false;
                
                return filters.every(f => {
                    if (f.val === "") return true;
                    const sv = fuzzyGet(s, f.key);
                    let v = parseFloat(sv) || 0;
                    let tv;

                    if (f.key === "åƒ¹æ ¼" && ["5MA", "10MA", "20MA", "60MA"].includes(f.val)) {
                        tv = parseFloat(fuzzyGet(s, f.val)) || 0;
                    } else {
                        tv = parseFloat(f.val) || 0;
                    }

                    if (f.op === "include") return String(sv || "").includes(f.val);
                    if (f.op === '>=') return v >= tv;
                    if (f.op === '<=') return v <= tv;
                    return v == tv;
                });
            });

            document.getElementById('result-count-badge').innerText = result.length;
            if (sortKey) {
                result.sort((a, b) => {
                    let vA = parseFloat(fuzzyGet(a, sortKey)) || 0, vB = parseFloat(fuzzyGet(b, sortKey)) || 0;
                    return vA > vB ? (1 * sortDirection) : (-1 * sortDirection);
                });
            }
            renderTable(result, filters.map(f => f.key));
        }

        function renderTable(data, dynamicKeys = []) {
            const thead = document.getElementById('table-head'), tbody = document.getElementById('stock-list');
            const colWidths = {
                "ä»£ç¢¼": "w-[80px]", "åç¨±": "w-[120px]", "åƒ¹æ ¼": "w-[80px]",
                "æ¼²è·Œ": "w-[90px]", "æ¼²è·Œå¹…": "w-[110px]", "æˆäº¤é‡": "w-[100px]",
                "5MA": "w-[80px]", "10MA": "w-[80px]", "20MA": "w-[80px]", "60MA": "w-[80px]",
                "ç”¢æ¥­": "w-[140px]", "ç¶“ç‡Ÿé …ç›®": "min-w-[280px]", "æ¦‚å¿µè‚¡": "min-w-[280px]",
                "å‹•æ…‹æŒ‡æ¨™": "w-[110px]"
            };

            const headFixed = ["ä»£ç¢¼", "åç¨±", "åƒ¹æ ¼", "æ¼²è·Œ", "æ¼²è·Œå¹…", "æˆäº¤é‡", "5MA", "10MA", "20MA", "60MA"];
            const tailFixed = ["ç”¢æ¥­", "ç¶“ç‡Ÿé …ç›®", "æ¦‚å¿µè‚¡"];
            const middleExtras = dynamicKeys.filter(k => !headFixed.includes(k) && !tailFixed.includes(k));
            const allHeaders = [...headFixed, ...middleExtras, ...tailFixed];
            
            thead.innerHTML = `<tr>${allHeaders.map(h => {
                const isExtra = middleExtras.includes(h);
                const widthClass = colWidths[h] || colWidths["å‹•æ…‹æŒ‡æ¨™"];
                const centerClass = (headFixed.includes(h) && h !== "ä»£ç¢¼" && h !== "åç¨±") || isExtra ? 'text-center' : '';
                return `<th class="p-4 cursor-pointer hover:bg-slate-200 transition-colors font-black ${widthClass} ${centerClass} ${isExtra ? 'text-indigo-600' : ''}" onclick="handleSort('${h}')">
                    ${h} ${sortKey===h?(sortDirection===1?'â†‘':'â†“'):''}
                </th>`;
            }).join('')}</tr>`;

            tbody.innerHTML = data.map(s => {
                const rowCells = allHeaders.map(h => {
                    const val = fuzzyGet(s, h);
                    const widthClass = colWidths[h] || colWidths["å‹•æ…‹æŒ‡æ¨™"];
                    if (h === "ä»£ç¢¼") {
                        const id = String(val).replace(/"/g, "");
                        return `<td class="p-5 font-mono font-bold text-indigo-500 italic text-[14px] ${widthClass}"><a href="https://tw.stock.yahoo.com/quote/${id}.TW/technical-analysis" target="_blank" class="hover:underline">${id}</a></td>`;
                    }
                    if (h === "åç¨±") return `<td class="p-5 font-bold text-slate-800 text-[14px] ${widthClass}">${val}</td>`;
                    if (h === "åƒ¹æ ¼") return `<td class="p-5 font-black text-indigo-600 text-[16px] italic ${widthClass}">${val || 0}</td>`;
                    
                    if (h === "æ¼²è·Œ") {
                        const num = parseFloat(val) || 0;
                        const colorClass = num > 0 ? 'text-red-500' : (num < 0 ? 'text-emerald-500' : 'text-slate-500');
                        return `<td class="p-5 font-black italic text-center ${colorClass} text-[16px] ${widthClass}">${val || 0}</td>`;
                    }
                    if (h === "æ¼²è·Œå¹…") {
                        const num = parseFloat(val) || 0;
                        const colorClass = num > 0 ? 'text-red-500' : (num < 0 ? 'text-emerald-500' : 'text-slate-500');
                        return `<td class="p-5 font-black italic text-center ${colorClass} text-[18px] ${widthClass}">${val || 0}</td>`;
                    }

                    if (["5MA", "10MA", "20MA", "60MA", "æˆäº¤é‡"].includes(h)) return `<td class="p-5 font-bold text-center text-slate-600 text-[14px] ${widthClass}">${val || 0}</td>`;
                    if (h === "ç”¢æ¥­") return `<td class="p-5 text-slate-600 font-medium text-[14px] ${widthClass}">${val}</td>`;
                    if (h === "ç¶“ç‡Ÿé …ç›®") return `<td class="p-5 py-6 ${widthClass}"><div class="text-slate-500 text-[12px] line-clamp-2" title="${val}">${val || 'ç„¡è³‡æ–™'}</div></td>`;
                    if (h === "æ¦‚å¿µè‚¡") return `<td class="p-5 py-6 ${widthClass}"><div class="text-slate-400 text-[11px] line-clamp-2" title="${val}">${val || 'ç„¡è³‡æ–™'}</div></td>`;
                    return `<td class="p-5 font-bold text-indigo-600 text-center bg-indigo-50/30 text-[14px] ${widthClass}">${val ?? '--'}</td>`;
                });
                return `<tr class="hover:bg-indigo-50/40 transition-colors border-b border-slate-100">${rowCells.join('')}</tr>`;
            }).join('');
        }

        window.handleSort = (key) => { if (sortKey === key) sortDirection *= -1; else { sortKey = key; sortDirection = -1; } runFilter(); };
        window.exportToExcel = () => {
            let csv = ["\uFEFF"];
            document.querySelectorAll('table tr').forEach(r => csv.push(Array.from(r.querySelectorAll('th, td')).map(c => `"${c.innerText.replace(/[â†‘â†“]/g,'').trim()}"`).join(',')));
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv.join("\n")], { type: 'text/csv' }));
            link.download = `é¸è‚¡çµæœ_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        init();
    </script>
</body>
</html>