<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é›„Stock Scanner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; }
        .filter-card { border-left: 4px solid #4f46e5; transition: all 0.2s; }
        thead th { position: sticky; top: 0; background: #f1f5f9; z-index: 20; white-space: nowrap; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-container { width: 100%; overflow-x: auto; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: auto; }
        td { white-space: nowrap; }
        .wrap-cell { white-space: normal !important; min-width: 250px; }

        .highlight-filter { background-color: #fdf2f8 !important; color: #db2777 !important; font-weight: 900 !important; }

        .name-badge { padding: 6px 14px; border-radius: 9999px; font-weight: 800; display: inline-block; transition: all 0.3s ease; }
        .limit-up-premium { background: linear-gradient(135deg, #ff4d4d 0%, #f43f5e 100%); color: white !important; box-shadow: 0 4px 12px rgba(244, 63, 94, 0.4); border: 1px solid rgba(255, 255, 255, 0.2); }
        .limit-down-premium { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white !important; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); }
        .name-normal { color: #1e293b; background: #f1f5f9; border: 1px solid #e2e8f0; }
        .ma-arrow { font-size: 20px; font-weight: 900; margin-left: 6px; vertical-align: middle; display: inline-block; }
        
        .news-icon { margin-left: 8px; font-size: 16px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; vertical-align: middle; text-decoration: none; }
        .news-icon:hover { opacity: 1; transform: scale(1.2); }

        /* ç›£æ§æ¸…å–®å°ˆå±¬æ¨£å¼ */
        .watchlist-container { border-top: 6px solid #4f46e5; }
        .password-overlay { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(6px); }
        .delete-btn { color: #cbd5e1; cursor: pointer; transition: color 0.2s; }
        .delete-btn:hover { color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">
    <div class="max-w-[1750px] mx-auto min-h-screen">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-indigo-600 tracking-tight italic uppercase">å¤§é›„Stock Scanner Pro</h1>
                <p class="text-slate-500 text-sm mt-1 font-bold italic">è²¡å¯Œè‡ªç”±</p>
            </div>
            <div class="flex flex-col items-end gap-1">
                <div class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl shadow-sm border border-slate-200">
                    <div id="spinner" class="loading-spinner"></div>
                    <span id="status" class="text-sm font-bold text-slate-600 italic">é€£ç·šä¸­...</span>
                </div>
                <span id="update-date" class="text-[10px] font-black text-indigo-400 mr-2 uppercase tracking-widest italic">è³‡æ–™æ—¥æœŸï¼šè®€å–ä¸­...</span>
            </div>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-200">
            <div class="mb-6 bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
                <div class="relative w-full">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 font-bold">ğŸ”</span>
                    <input type="text" id="keyword-search" oninput="runFilter()" 
                        class="block w-full pl-10 pr-3 py-3 border border-slate-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-bold shadow-inner" 
                        placeholder="æœå°‹ä»£è™Ÿã€åç¨±">
                </div>
            </div>

            <div id="filter-container" class="space-y-3"></div>

            <div class="mt-8 flex flex-wrap gap-3 border-t border-slate-100 pt-6 items-center">
                <button onclick="addFilterRow()" class="bg-slate-800 text-white px-6 py-3 rounded-xl hover:bg-slate-700 transition font-bold shadow-lg text-[14px]">+ æ–°å¢ç¯©é¸</button>
                <div class="flex-1 flex items-center gap-4">
                    <button onclick="runFilter()" class="bg-indigo-600 text-white px-10 py-3 rounded-xl font-black hover:bg-indigo-700 transition shadow-lg text-[14px]">åŸ·è¡Œé¸è‚¡</button>
                    <div class="bg-indigo-50 px-4 py-2.5 rounded-xl border border-indigo-100 flex items-center">
                        <span id="result-count-badge" class="text-indigo-600 font-black text-[18px]">0</span>
                        <span class="text-indigo-400 text-xs font-bold uppercase ml-2">æ”¯ç¬¦åˆ</span>
                    </div>
                    <button id="toggle-extras-btn" onclick="toggleExtras()" class="bg-blue-50 text-blue-600 px-4 py-2.5 rounded-xl font-bold hover:bg-blue-100 transition text-[13px] border border-blue-200">
                        ğŸ”­ é¡¯ç¤ºå®Œæ•´æ¬„ä½
                    </button>
                    <button onclick="clearAllFilters()" class="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-xl font-bold hover:bg-red-100 hover:text-red-600 transition text-[13px] flex items-center gap-2">
                        <span>ğŸ§¹</span> ä¸€éµæ¸…é™¤
                    </button>
                </div>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition text-[14px]">åŒ¯å‡º CSV</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl mb-8 border border-slate-200 overflow-hidden watchlist-container">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-2">
                    <span class="text-xl">â­</span>
                    <h2 class="text-xl font-black text-indigo-700 italic tracking-tight uppercase">æˆ‘çš„ç›£æ§æ¸…å–®</h2>
                </div>
                <div id="unlock-area" class="flex gap-2">
                    <input type="password" id="watchlist-pw" placeholder="è¼¸å…¥å¯†ç¢¼" class="p-2 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-400 font-bold">
                    <button onclick="unlockWatchlist()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-md hover:bg-indigo-700 transition">è§£é–</button>
                </div>
                <button id="lock-btn" onclick="lockWatchlist()" class="hidden bg-slate-200 text-slate-600 px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-300">ğŸ”’ é‡æ–°ä¸Šé–</button>
            </div>
            
            <div class="relative min-h-[120px]">
                <div id="pw-mask" class="password-overlay absolute inset-0 z-50 flex flex-col items-center justify-center p-6 text-center">
                    <span class="text-3xl mb-2">ğŸ”’</span>
                    <p class="font-black text-slate-400 uppercase tracking-widest text-xs italic">Encrypted Watchlist / å¯†ç¢¼é©—è­‰ä¸­</p>
                </div>

                <div class="table-container max-h-[400px] overflow-y-auto">
                    <table class="min-w-full">
                        <thead class="bg-slate-100/50">
                            <tr class="text-slate-400 text-[10px] font-black uppercase border-b text-center">
                                <th class="p-3">åºè™Ÿ</th>
                                <th class="p-3">ä»£è™Ÿ</th>
                                <th class="p-3">åç¨±</th>
                                <th class="p-3">ç¾åƒ¹</th>
                                <th class="p-3">æ¼²è·Œ</th>
                                <th class="p-3">æ¼²è·Œå¹…</th>
                                <th class="p-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="watchlist-body" class="divide-y divide-slate-100 text-center font-bold text-sm">
                            <tr><td colspan="7" class="p-10 text-slate-300 italic">ç›®å‰æ˜¯ç©ºçš„ï¼Œé»æ“Šä»£ç¢¼æ—çš„åŠ è™ŸåŠ å…¥</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="table-container">
                <table class="text-left">
                    <thead id="table-head">
                        <tr class="text-slate-400 text-[11px] uppercase border-b">
                            <th class="p-4">ç­‰å¾…é€£ç·šä¸­...</th>
                        </tr>
                    </thead>
                    <tbody id="stock-list" class="text-slate-700 divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcrQxCW62uLQpwra3gAHBedfhixQ8xdYU",
            authDomain: "test-f194b.firebaseapp.com",
            projectId: "test-f194b",
            storageBucket: "test-f194b.firebasestorage.app",
            messagingSenderId: "538788175196",
            appId: "1:538788175196:web:f73a483780f656f85a7599"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let allStocks = [], sortKey = '', sortDirection = 1, uniqueOptions = {};
        let showAllExtras = false;
        let watchlist = JSON.parse(localStorage.getItem('myWatchlist') || '[]');
        const WATCHLIST_PASSWORD = "7330"; 

        const indicatorGroups = {
            "ğŸ¯ æ ¸å¿ƒè¡Œæƒ…": ["åƒ¹æ ¼", "æ¼²è·Œ", "æ¼²è·Œå¹…", "æˆäº¤é‡"],
            "ğŸ” åŸºç¤å±¬æ€§": ["ç±Œç¢¼åŠ›é“", "ç”¢æ¥­", "è‚¡æœ¬(å„„)"],
            "ğŸ’° ç±Œç¢¼å‹•å‘": ["å¤–è³‡è²·è³£è¶…", "æŠ•ä¿¡è²·è³£è¶…", "è‡ªç‡Ÿå•†è²·è³£è¶…", "è¿‘1æ—¥ä¸»åŠ›è²·è³£è¶…", "è¿‘5æ—¥ä¸»åŠ›è²·è³£è¶…", "è¿‘20æ—¥ä¸»åŠ›è²·è³£è¶…", "ä¸»åŠ›é€£çºŒè²·è³£å¤©æ•¸", "ä¸»åŠ›é€£çºŒè²·è³£å¼µæ•¸"],
            "ğŸ“Š ç±Œç¢¼é›†ä¸­": ["è¿‘5æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘10æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘20æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘60æ—¥ç±Œç¢¼é›†ä¸­åº¦"],
            "ğŸ’ è²¡å ±å›å ±": ["è¿‘5å¹´å¹³å‡ç¾é‡‘æ®–åˆ©ç‡%"]
        };

        const colorSensitiveFields = [
            "å¤–è³‡è²·è³£è¶…", "æŠ•ä¿¡è²·è³£è¶…", "è‡ªç‡Ÿå•†è²·è³£è¶…", "è¿‘1æ—¥ä¸»åŠ›è²·è³£è¶…", "è¿‘5æ—¥ä¸»åŠ›è²·è³£è¶…", 
            "è¿‘20æ—¥ä¸»åŠ›è²·è³£è¶…", "ä¸»åŠ›é€£çºŒè²·è³£å¤©æ•¸", "ä¸»åŠ›é€£çºŒè²·è³£å¼µæ•¸", 
            "è¿‘5æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘10æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘20æ—¥ç±Œç¢¼é›†ä¸­åº¦", "è¿‘60æ—¥ç±Œç¢¼é›†ä¸­åº¦"
        ];

        function fuzzyGet(obj, target) {
            if (!obj) return "";
            if (obj[target] !== undefined) return obj[target];
            const cleanTarget = target.toString().trim().replace(/[ "â€œâ€'']/g, "");
            const realKey = Object.keys(obj).find(k => {
                const cleanK = k.toString().trim().replace(/[ "â€œâ€'']/g, "").replace(/\ufeff/g, "");
                return cleanK === cleanTarget || cleanK.includes(cleanTarget);
            });
            return realKey ? obj[realKey] : "";
        }

        async function init() {
            const status = document.getElementById('status'), dateTxt = document.getElementById('update-date'), spinner = document.getElementById('spinner');
            try {
                const dSnap = await getDoc(doc(db, "settings", "lastUpdate"));
                if (dSnap.exists()) dateTxt.innerText = "è³‡æ–™æ—¥æœŸï¼š" + dSnap.data().date;
                const snap = await getDocs(collection(db, "stocks"));
                allStocks = snap.docs.map(doc => doc.data());
                ["ç±Œç¢¼åŠ›é“", "ç”¢æ¥­"].forEach(k => {
                    let set = new Set();
                    allStocks.forEach(s => { const v = fuzzyGet(s, k); if(v) set.add(v); });
                    uniqueOptions[k] = Array.from(set).sort();
                });
                status.innerText = `å·²è¼‰å…¥ ${allStocks.length} æ”¯`;
                spinner.style.display = 'none';
                addFilterRow();
                runFilter();
            } catch (e) { status.innerText = "é€£ç·šå¤±æ•—"; }
        }

        window.unlockWatchlist = function() {
            const pw = document.getElementById('watchlist-pw').value;
            if (pw === WATCHLIST_PASSWORD) {
                document.getElementById('pw-mask').classList.add('hidden');
                document.getElementById('unlock-area').classList.add('hidden');
                document.getElementById('lock-btn').classList.remove('hidden');
                renderWatchlist();
            } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
        }

        window.lockWatchlist = function() {
            document.getElementById('pw-mask').classList.remove('hidden');
            document.getElementById('unlock-area').classList.remove('hidden');
            document.getElementById('lock-btn').classList.add('hidden');
            document.getElementById('watchlist-pw').value = '';
        }

        window.addToWatchlist = function(stockId) {
            if (watchlist.includes(stockId)) {
                alert("æ­¤è‚¡ç¥¨å·²åœ¨æ¸…å–®ä¸­");
                return;
            }
            watchlist.push(stockId);
            localStorage.setItem('myWatchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        window.removeFromWatchlist = function(stockId) {
            watchlist = watchlist.filter(id => id !== stockId);
            localStorage.setItem('myWatchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlist-body');
            if (watchlist.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-10 text-slate-300 italic">ç›®å‰æ˜¯ç©ºçš„ï¼Œé»æ“Šä»£ç¢¼æ—çš„åŠ è™ŸåŠ å…¥</td></tr>`;
                return;
            }
            tbody.innerHTML = watchlist.map((id, index) => {
                const s = allStocks.find(item => String(fuzzyGet(item, "ä»£ç¢¼")).replace(/[ "]/g, "") === id);
                if (!s) return "";
                const price = fuzzyGet(s, "åƒ¹æ ¼"), change = fuzzyGet(s, "æ¼²è·Œ"), pct = fuzzyGet(s, "æ¼²è·Œå¹…"), name = fuzzyGet(s, "åç¨±");
                const numChange = parseFloat(change) || 0;
                const colorClass = numChange > 0 ? 'text-red-500' : (numChange < 0 ? 'text-emerald-500' : 'text-slate-500');
                return `<tr class="hover:bg-indigo-50/30 transition-colors">
                    <td class="p-3 text-slate-400 text-[10px]">${index + 1}</td>
                    <td class="p-3 text-blue-600 font-black italic">${id}</td>
                    <td class="p-3 text-slate-800">${name}</td>
                    <td class="p-3 text-indigo-600 font-black">${price}</td>
                    <td class="p-3 ${colorClass}">${change}</td>
                    <td class="p-3 ${colorClass}">${pct}%</td>
                    <td class="p-3"><span onclick="removeFromWatchlist('${id}')" class="delete-btn text-lg">âœ•</span></td>
                </tr>`;
            }).join('');
        }

        window.toggleExtras = function() {
            showAllExtras = !showAllExtras;
            document.getElementById('toggle-extras-btn').innerText = showAllExtras ? "ğŸ”­ éš±è—å»¶ä¼¸æ¬„ä½" : "ğŸ”­ é¡¯ç¤ºå®Œæ•´æ¬„ä½";
            runFilter();
        }

        window.clearAllFilters = function() {
            document.getElementById('keyword-search').value = '';
            document.getElementById('filter-container').innerHTML = '';
            addFilterRow();
            runFilter();
        }

        window.addFilterRow = function() {
            const container = document.getElementById('filter-container');
            const row = document.createElement('div');
            row.className = "filter-card flex flex-wrap gap-3 bg-slate-50 p-4 rounded-2xl items-center animate-fadeIn shadow-sm border border-slate-100";
            let groups = "";
            for (let g in indicatorGroups) {
                groups += `<optgroup label="${g}">`;
                indicatorGroups[g].forEach(i => groups += `<option value="${i}">${i}</option>`);
                groups += `</optgroup>`;
            }
            row.innerHTML = `<select onchange="updateValueInput(this)" class="indicator-select p-2 border rounded-xl bg-white w-full md:w-64 font-bold outline-none">${groups}</select>
                <select class="operator-select p-2 border rounded-xl bg-white w-20 text-center font-black"><option value=">=">â‰¥</option><option value="<=">â‰¤</option><option value="==">=</option><option value="include">å«</option></select>
                <div class="value-container flex-1 md:flex-none"></div>
                <button onclick="this.parentElement.remove(); runFilter();" class="ml-auto text-slate-300 hover:text-red-500 font-bold px-2 text-xl">âœ•</button>`;
            container.appendChild(row);
            updateValueInput(row.querySelector('select'));
        }

        window.updateValueInput = function(selectEl) {
            const row = selectEl.parentElement, valContainer = row.querySelector('.value-container'), key = selectEl.value;
            if (key === "åƒ¹æ ¼") {
                valContainer.innerHTML = `<input list="ma-options" class="p-2 border rounded-xl bg-white w-full md:w-32 font-black text-indigo-600 outline-none" placeholder="æ•¸å­—æˆ–MA">
                    <datalist id="ma-options"><option value="5MA"><option value="10MA"><option value="20MA"><option value="60MA"></datalist>`;
            } else if (["ç±Œç¢¼åŠ›é“", "ç”¢æ¥­"].includes(key)) {
                let opts = (uniqueOptions[key] || []).map(o => `<option value="${o}">${o}</option>`).join('');
                valContainer.innerHTML = `<select class="p-2 border rounded-xl bg-white w-full md:w-48 font-bold text-indigo-600">${opts}</select>`;
                row.querySelector('.operator-select').value = "include";
            } else {
                valContainer.innerHTML = `<input type="number" step="any" class="p-2 border rounded-xl bg-white w-full md:w-32 font-black text-indigo-600">`;
                row.querySelector('.operator-select').value = ">=";
            }
        }

        window.runFilter = function() {
            const keyword = document.getElementById('keyword-search')?.value.toLowerCase().trim() || "";
            const filterRows = document.querySelectorAll('#filter-container > div');
            const filters = Array.from(filterRows).map(r => ({
                key: r.querySelector('select').value, op: r.querySelector('.operator-select').value, 
                val: r.querySelector('.value-container').querySelector('input, select')?.value || ""
            }));

            let result = allStocks.filter(s => {
                if (keyword) {
                    const id = String(fuzzyGet(s, "ä»£ç¢¼")).replace(/[ "]/g, "");
                    const name = String(fuzzyGet(s, "åç¨±")).toLowerCase();
                    if (!id.includes(keyword) && !name.includes(keyword)) return false;
                }
                return filters.every(f => {
                    if (f.val === "") return true;
                    const sv = fuzzyGet(s, f.key);
                    let v = parseFloat(sv) || 0, tv;
                    if (f.key === "åƒ¹æ ¼" && ["5MA", "10MA", "20MA", "60MA"].includes(f.val)) {
                        tv = parseFloat(fuzzyGet(s, f.val)) || 0;
                    } else { tv = parseFloat(f.val) || 0; }
                    if (f.op === "include") return String(sv || "").includes(f.val);
                    if (f.op === '>=') return v >= tv;
                    if (f.op === '<=') return v <= tv;
                    return v == tv;
                });
            });

            document.getElementById('result-count-badge').innerText = result.length;
            if (sortKey) {
                result.sort((a, b) => {
                    let vA = parseFloat(fuzzyGet(a, sortKey)) || 0, vB = parseFloat(fuzzyGet(b, sortKey)) || 0;
                    return vA > vB ? (1 * sortDirection) : (-1 * sortDirection);
                });
            }
            renderTable(result, filters.map(f => f.key));
            if (document.getElementById('pw-mask').classList.contains('hidden')) { renderWatchlist(); }
        }

        function renderTable(data, activeFilterKeys = []) {
            const thead = document.getElementById('table-head'), tbody = document.getElementById('stock-list');
            const headFixed = ["ä»£ç¢¼", "åç¨±", "åƒ¹æ ¼", "æ¼²è·Œ", "æ¼²è·Œå¹…", "æˆäº¤é‡", "5MA", "10MA", "20MA", "60MA"];
            const tailFixed = ["ç”¢æ¥­", "ç¶“ç‡Ÿé …ç›®", "æ¦‚å¿µè‚¡"];
            const allPossibleExtras = Object.values(indicatorGroups).flat();
            const actualExtras = showAllExtras ? allPossibleExtras.filter(k => !headFixed.includes(k) && !tailFixed.includes(k)) : [];
            const highlightedExtras = activeFilterKeys.filter(k => !headFixed.includes(k) && !tailFixed.includes(k) && !actualExtras.includes(k));
            const allHeaders = [...headFixed, ...actualExtras, ...highlightedExtras, ...tailFixed];
            
            thead.innerHTML = `<tr>${allHeaders.map(h => `<th class="p-4 cursor-pointer hover:bg-slate-200 transition-colors font-black" onclick="handleSort('${h}')">${h} ${sortKey===h?(sortDirection===1?'â†‘':'â†“'):''}</th>`).join('')}</tr>`;

            tbody.innerHTML = data.map(s => {
                const pctChange = parseFloat(fuzzyGet(s, "æ¼²è·Œå¹…")) || 0;
                const currentPrice = parseFloat(fuzzyGet(s, "åƒ¹æ ¼")) || 0;
                const stockId = String(fuzzyGet(s, "ä»£ç¢¼")).replace(/[ "]/g, "");
                let nameStyle = "name-badge name-normal";
                if (pctChange >= 9.5) nameStyle = "name-badge limit-up-premium";
                else if (pctChange <= -9.5) nameStyle = "name-badge limit-down-premium";

                const rowCells = allHeaders.map(h => {
                    const val = fuzzyGet(s, h);
                    const num = parseFloat(val) || 0;
                    const isFilteredCol = activeFilterKeys.includes(h) ? "highlight-filter" : "";

                    if (h === "ä»£ç¢¼") {
                        return `<td class="p-5 font-bold text-blue-600 underline italic ${isFilteredCol}">
                            <div class="flex items-center gap-3">
                                <button onclick="addToWatchlist('${stockId}')" class="text-indigo-500 hover:text-indigo-700 transition-all hover:scale-125 flex items-center justify-center" title="åŠ å…¥ç›£æ§">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                </button>
                                <a href="https://tw.stock.yahoo.com/quote/${stockId}.TW/technical-analysis" target="_blank">${stockId}</a>
                            </div>
                        </td>`;
                    }
                    if (h === "åç¨±") {
                        return `<td class="p-5 text-center ${isFilteredCol}">
                            <div class="flex items-center justify-center">
                                <span class="${nameStyle}">${val}</span>
                                <a href="https://www.cnyes.com/search/news?keyword=${stockId}" target="_blank" class="news-icon" title="é‰…äº¨æœå°‹æ–°è">ğŸ“°</a>
                            </div>
                        </td>`;
                    }
                    if (h === "åƒ¹æ ¼") return `<td class="p-5 font-black text-indigo-600 italic text-[22px] ${isFilteredCol}">${val || 0}</td>`;
                    let colorClass = 'text-slate-600';
                    if (h === "æ¼²è·Œ" || h === "æ¼²è·Œå¹…" || colorSensitiveFields.includes(h)) {
                        colorClass = (num > 0) ? 'text-red-500' : (num < 0 ? 'text-emerald-500' : 'text-slate-500');
                    }
                    if (h === "æ¼²è·Œ" || h === "æ¼²è·Œå¹…") {
                        const fontSize = h === "æ¼²è·Œå¹…" ? 'text-[20px]' : 'text-[17px]';
                        return `<td class="p-5 font-black italic text-center ${colorClass} ${fontSize} ${isFilteredCol}">${val || 0}</td>`;
                    }
                    if (h === "ç¶“ç‡Ÿé …ç›®" || h === "æ¦‚å¿µè‚¡") return `<td class="p-5 py-6 wrap-cell text-slate-500 text-[12px] ${isFilteredCol}">${val || 'ç„¡è³‡æ–™'}</td>`;
                    if (["5MA", "10MA", "20MA", "60MA"].includes(h)) {
                        let arrow = "";
                        if (currentPrice > num && num !== 0) arrow = `<span class="text-red-500 ma-arrow">â†‘</span>`;
                        else if (currentPrice < num && num !== 0) arrow = `<span class="text-emerald-500 ma-arrow">â†“</span>`;
                        return `<td class="p-5 font-bold text-center text-slate-600 text-[15px] ${isFilteredCol}">${num}${arrow}</td>`;
                    }
                    const cellWeight = colorSensitiveFields.includes(h) ? "font-black" : "font-bold";
                    return `<td class="p-5 ${cellWeight} text-center ${colorClass} ${isFilteredCol}">${val ?? '--'}</td>`;
                });
                return `<tr class="hover:bg-indigo-50/40 border-b border-slate-100">${rowCells.join('')}</tr>`;
            }).join('');
        }
        window.handleSort = (key) => { if (sortKey === key) sortDirection *= -1; else { sortKey = key; sortDirection = -1; } runFilter(); };
        window.exportToExcel = () => {
            let csv = ["\uFEFF"];
            document.querySelectorAll('table tr').forEach(r => csv.push(Array.from(r.querySelectorAll('th, td')).map(c => `"${c.innerText.trim()}"`).join(',')));
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv.join("\n")], { type: 'text/csv' }));
            link.download = `é¸è‚¡çµæœ_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };
        init();
    </script>
</body>
</html>